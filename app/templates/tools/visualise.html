{% extends "tools/base.html" %}

{% block page_header %}Visualise Your Image{% endblock %}
{% block page_subheader %}Select one of your uploaded images to analyse its visual and file features.{% endblock %}

{% block tools_content %}
<style>
  /* add any custom styles here */
</style>

<!-- Modal for selecting image -->
<div class="modal fade" id="imageSelectModal" tabindex="-1" aria-labelledby="imageSelectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageSelectModalLabel">Select an Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- your image cards go here -->
        <div class="row">
          {% for img in images %}
            <div class="col-md-3 mb-3">
              <div class="card" onclick="selectImageFromCard(this)">
                <img src="{{ url_for('static', filename=img.path) }}" class="card-img-top" alt="{{ img.name }}">
                <div class="card-body">
                  <p class="card-text text-truncate">{{ img.name }}</p>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mt-4" style="padding-bottom: 80px;">
  <!-- Left Column: Image Preview and Metadata -->
  <div class="col-lg-6 d-flex flex-column">
    <div class="card mb-4" style="min-height: 400px;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 id="image-title" class="mb-0">Image Title</h5>
        <a href="#" data-bs-toggle="modal" data-bs-target="#imageSelectModal">
          <img id="img_icon" class="icon-hover"
               src="{{ url_for('static', filename='images/arrow-path.svg') }}"
               style="width: 20px; height: 20px; vertical-align: middle;">
        </a>
      </div>
      <div class="card-body text-center">
        <div id="image-placeholder" class="image-placeholder">
          <p class="text-muted">No image selected</p>
        </div>
        <img id="selected-image" src="" class="img-fluid d-none" alt="Selected image">
      </div>
      <div class="card-footer">
        <ul class="list-unstyled mb-0">
          <li><strong>Resolution:</strong> <span id="resolution">-</span></li>
          <li><strong>File Type:</strong> <span id="filetype">-</span></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Right Column: Histogram and Colour Channel Breakdown -->
  <div class="col-lg-6 d-flex flex-column">
    <div class="card mb-4">
      <div class="card-header">Histogram</div>
      <div class="card-body text-center">
        <p id="hist_prev" class="text-muted">Histogram plot will appear here.</p>
        <canvas id="histogramChart"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="card-header">Colour Channel Analysis</div>
      <div class="card-body text-center">
        <p id="channel_prev" class="text-muted">Colour channels plot will appear here.</p>
        <canvas id="colochanChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { handleImageSelection } from "{{ url_for('static', filename='js/imageSelector.js') }}";

  function calculateImageData(imageElement) {
    const canvas = document.createElement('canvas');
    canvas.width = imageElement.naturalWidth;
    canvas.height = imageElement.naturalHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(imageElement, 0, 0);

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;

    const histogram = new Array(256).fill(0);
    const red = new Array(256).fill(0);
    const green = new Array(256).fill(0);
    const blue = new Array(256).fill(0);

    for (let i = 0; i < data.length; i += 4) {
      const r = data[i], g = data[i+1], b = data[i+2];
      const gray = Math.round((r + g + b) / 3);
      histogram[gray]++;
      red[r]++; green[g]++; blue[b]++;
    }

    return { histogramData: histogram, colorChanData: { red, green, blue } };
  }

  let histogramChartInstance = null;
  let colorChartInstance = null;

  window.selectImageFromCard = function(card) {
    handleImageSelection(card, {
      imgElement:       document.getElementById('selected-image'),
      labelElement:     document.getElementById('image-title'),
      placeholderElement: document.getElementById('image-placeholder'),
      placeholderIds:   ["channel_prev", "hist_prev"],
      resolutionElement: document.getElementById('resolution'),
      fileTypeElement:   document.getElementById('filetype'),
      iconElement:       document.getElementById('img_icon'),
      updateIcon:        "{{ url_for('static', filename='images/arrow-path.svg') }}",
      onImageSelected: () => {
        const img   = document.getElementById('selected-image');
        const resEl = document.getElementById('resolution');
        const ftEl  = document.getElementById('filetype');

        const render = () => {
          // Metadata
          resEl.textContent = img.naturalWidth + 'Ã—' + img.naturalHeight;
          ftEl.textContent  = img.src.split('.').pop();

          // Data extraction
          const { histogramData, colorChanData } = calculateImageData(img);

          // Intensity histogram
          if (histogramChartInstance) histogramChartInstance.destroy();
          const ctxH = document.getElementById('histogramChart').getContext('2d');
          histogramChartInstance = new Chart(ctxH, {
            type: 'bar',
            data: {
              labels: Array.from({ length: 256 }, (_, i) => i),
              datasets: [{
                label: 'Intensity Distribution',
                data: histogramData,
                backgroundColor: 'rgba(54, 162, 235, 0.6)'
              }]
            },
            options: { scales: { y: { beginAtZero: true } } }
          });

          // Colour channels
          if (colorChartInstance) colorChartInstance.destroy();
          const ctxC = document.getElementById('colochanChart').getContext('2d');
          colorChartInstance = new Chart(ctxC, {
            type: 'bar',
            data: {
              labels: Array.from({ length: 256 }, (_, i) => i),
              datasets: [
                { label: 'Red Channel', data: colorChanData.red },
                { label: 'Green Channel', data: colorChanData.green },
                { label: 'Blue Channel', data: colorChanData.blue }
              ]
            },
            options: { scales: { y: { beginAtZero: true } } }
          });
        };

        // Only run once image is fully loaded
        if (img.complete && img.naturalWidth > 0) {
          render();
        } else {
          img.addEventListener('load', render, { once: true });
        }
      }
    });
  };
</script>
{% endblock %}
